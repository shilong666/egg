<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>水印相机</title>
    <style>
      * {
        box-sizing: border-box;
        padding: 0;
        margin: 0;
      }
      body {
        width: 100vw;
        height: 100vh;
        position: relative;
        overflow: hidden;
        background-color: #000;
      }
      .camera-video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        position: absolute;
        top: 0;
        left: 0;
        z-index: 1;
      }
      canvas {
        position: absolute;
        left: -9999px;
        visibility: hidden;
      }
      .capture-btn {
        position: fixed;
        bottom: 40px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 10;
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background-color: rgba(255, 255, 255, 0.4);
        border: none;
        outline: none;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        transition: all 0.3s ease;
      }
      .capture-btn:active {
        transform: translateX(-50%) scale(0.95);
        box-shadow: 0 0 5px rgba(255, 255, 255, 0.3);
      }
      .capture-btn::after {
        content: '';
        width: 70px;
        height: 70px;
        border-radius: 50%;
        background-color: #fff;
        border: 4px solid rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
      }
      .download-link {
        position: absolute;
        bottom: 40px;
        right: 20px;
        z-index: 30;
        color: white;
        text-decoration: none;
        background-color: #007aff;
        padding: 12px 24px;
        border-radius: 8px;
        display: none;
        font-weight: bold;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 40;
        display: none;
        justify-content: center;
        align-items: center;
        flex-direction: column;
      }
      .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
        margin-bottom: 15px;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .loading-text {
        color: white;
        font-size: 16px;
      }

      /* 新增优化的预览层按钮样式 */
      .preview-buttons {
        position: absolute;
        bottom: 40px;
        width: 100%;
        display: flex;
        justify-content: center;
        gap: 20px; /* 增加按钮间的间隙 */
      }

      .preview-btn {
        padding: 12px 24px;
        background-color: #007aff;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
        min-width: 120px;
        text-align: center;
      }

      .preview-btn:active {
        transform: scale(0.95);
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
      }
    </style>
  </head>
  <body>
    <video class="camera-video" id="video" autoplay playsinline></video>
    <button class="capture-btn" id="capture"></button>
    <canvas id="canvas" width="300" height="300"></canvas>
    <a id="download" class="download-link" download="watermarked-photo.png"
      >保存图片</a
    >
    <div class="loading-overlay" id="loading-overlay">
      <div class="spinner"></div>
      <div class="loading-text">正在保存图片...</div>
    </div>
    <div id="preivew-image"></div>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const captureButton = document.getElementById('capture');
        const downloadLink = document.getElementById('download');
        const loadingOverlay = document.getElementById('loading-overlay');
        const previewImage = document.getElementById('preview-image');
        const previewLayer = document.getElementById('preview-layer');

        initCamera();

        captureButton.addEventListener('click', handleCapture);

        document.getElementById('close-preview').addEventListener('click', () => {
          previewLayer.style.display = 'none';
          downloadLink.style.display = 'none';
          video && video.play();
        });

        document.getElementById('save-image').addEventListener('click', handleSaveImage);

        async function handleCapture() {
          showLoading('正在处理图片...');
          try {
            video && video.pause();
            const frame = captureFrame();
            const imageUrl = await withTimeout(processImage(frame), 15000, () => {
              hideLoading();
              showError('处理图片超时，请重试');
              video && video.play();
            });

            previewImage.onload = () => {
              hideLoading();
              previewLayer.style.display = 'block';
            };

            previewImage.onerror = () => {
              hideLoading();
              showError('图片加载失败，请重试');
              video && video.play();
              previewLayer.style.display = 'none';
            };

            previewImage.src = '';
            requestAnimationFrame(() => {
              previewImage.src = imageUrl;
            });
          } catch (error) {
            hideLoading();
            showError('处理图片失败: ' + error.message);
            video && video.play();
          }
        }

        function handleSaveImage() {
          showLoading('正在保存图片...');
          try {
            if (!previewImage || !previewImage.src) throw new Error('图片数据不存在或已失效');

            const link = document.createElement('a');
            link.href = previewImage.src;
            link.download = 'watermarked-photo.png';
            link.click();

            setTimeout(() => {
              hideLoading();
              showError('图片已保存');
            }, 1000);
          } catch (error) {
            hideLoading();
            showError('保存图片失败: ' + error.message);
          }
        }

        function showLoading(message) {
          loadingOverlay.style.display = 'flex';
          loadingOverlay.querySelector('.loading-text').textContent = message;
        }

        function hideLoading() {
          loadingOverlay.style.display = 'none';
        }
      });
    </script>
  </body>
</html>
